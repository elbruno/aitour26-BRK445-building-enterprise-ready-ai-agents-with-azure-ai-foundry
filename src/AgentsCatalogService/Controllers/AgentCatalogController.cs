#pragma warning disable SKEXP0110

using Microsoft.AspNetCore.Mvc;
using Microsoft.SemanticKernel;
using Microsoft.SemanticKernel.Agents.AzureAI;
using Microsoft.SemanticKernel.ChatCompletion;
using Microsoft.Agents.AI;
using SharedEntities;
using ZavaAIFoundrySKAgentsProvider;
using ZavaAgentFxAgentsProvider;

namespace AgentsCatalogService.Controllers;

[ApiController]
[Route("api")]
public class AgentCatalogController : ControllerBase
{
    private readonly ILogger<AgentCatalogController> _logger;
    private AzureAIAgent? _agent;
    private readonly AIFoundryAgentProvider _aIFoundryAgentProvider;
    private readonly AgentFxAgentProvider _agentFxAgentProvider;

    public AgentCatalogController(
        ILogger<AgentCatalogController> logger,
        AIFoundryAgentProvider aIFoundryAgentProvider,
        AgentFxAgentProvider agentFxAgentProvider)
    {
        _logger = logger;
        _aIFoundryAgentProvider = aIFoundryAgentProvider;
        _agentFxAgentProvider = agentFxAgentProvider;
    }

    [HttpGet("agents")]
    public ActionResult<AgentListResponse> GetAvailableAgents()
    {
        try
        {
            _logger.LogInformation("Fetching available agents");

            var agents = new AgentListResponse
            {
                Agents = AgentCatalog.Agents.ToArray()
            };

            return Ok(agents);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error fetching available agents");
            return StatusCode(500, "Error fetching available agents");
        }
    }

    [HttpPost("testsk")]
    public async Task<ActionResult<AgentTesterResponse>> TestAgentSKAsync([FromBody] AgentTesterRequest request)
    {
        var agentId = "";
        var question = "";

        try
        {
            _logger.LogInformation("Testing agent {AgentId} with Semantic Kernel, question: {Question}", request.AgentId, request.Question);

            agentId = request.AgentId;
            question = request.Question;

            var prompt = BuildTestPrompt(agentId, question);

            // Create a Semantic Kernel agent based on the agent definition using the agentId
            var agentResponse = string.Empty;
            _agent = await _aIFoundryAgentProvider.GetAzureAIAgent(agentId);
            AzureAIAgentThread agentThread = new(_agent.Client);

            ChatMessageContent message = new(AuthorRole.User, prompt);
            await foreach (ChatMessageContent response in _agent.InvokeAsync(message, agentThread))
            {
                _logger.LogInformation("Received response from agent: {Content}", response.Content);
                agentResponse += (response.Content);
            }

            var agentTesterResponse = new AgentTesterResponse
            {
                AgentId = agentId,
                AgentName = AgentCatalog.GetAgentName(agentId),
                Question = question,
                Response = string.IsNullOrWhiteSpace(agentResponse)
                    ? GenerateFallbackResponse(agentId, question)
                    : agentResponse,
                Timestamp = DateTime.UtcNow,
                IsSuccessful = !string.IsNullOrWhiteSpace(agentResponse),
                ErrorMessage = string.IsNullOrWhiteSpace(agentResponse)
                    ? "No response generated by the agent."
                    : null
            };
            _logger.LogInformation("Agent response: {Response}", agentTesterResponse.Response);

            return Ok(agentTesterResponse);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error testing agent {AgentId} with Semantic Kernel", agentId);

            var fallbackResponse = new AgentTesterResponse
            {
                AgentId = agentId,
                AgentName = AgentCatalog.GetAgentName(agentId),
                Question = question,
                Response = $"Error occurred while processing your question: {ex.Message}",
                Timestamp = DateTime.UtcNow,
                IsSuccessful = false,
                ErrorMessage = ex.Message
            };

            return Ok(fallbackResponse);
        }
    }

    [HttpPost("testagentfx")]
    public async Task<ActionResult<AgentTesterResponse>> TestAgentFxAsync([FromBody] AgentTesterRequest request)
    {
        var agentId = "";
        var question = "";

        try
        {
            _logger.LogInformation("Testing agent {AgentId} with Agent Framework, question: {Question}", request.AgentId, request.Question);

            agentId = request.AgentId;
            question = request.Question;

            var prompt = BuildTestPrompt(agentId, question);

            // Use Microsoft Agent Framework
            var agentResponse = string.Empty;
            var agent = await _agentFxAgentProvider.GetAzureAIAgent(agentId);
            
            // TODO: Implement actual Agent Framework invocation
            // For now, use fallback
            _logger.LogWarning("Agent Framework integration pending - using fallback");
            agentResponse = GenerateFallbackResponse(agentId, question);

            var agentTesterResponse = new AgentTesterResponse
            {
                AgentId = agentId,
                AgentName = AgentCatalog.GetAgentName(agentId),
                Question = question,
                Response = agentResponse,
                Timestamp = DateTime.UtcNow,
                IsSuccessful = true,
                ErrorMessage = null
            };
            _logger.LogInformation("Agent response: {Response}", agentTesterResponse.Response);

            return Ok(agentTesterResponse);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error testing agent {AgentId} with Agent Framework", agentId);

            var fallbackResponse = new AgentTesterResponse
            {
                AgentId = agentId,
                AgentName = AgentCatalog.GetAgentName(agentId),
                Question = question,
                Response = $"Error occurred while processing your question: {ex.Message}",
                Timestamp = DateTime.UtcNow,
                IsSuccessful = false,
                ErrorMessage = ex.Message
            };

            return Ok(fallbackResponse);
        }
    }

    private string BuildTestPrompt(string agentId, string question)
    {
        return $@"
You are a helpful AI assistant specializing in DIY projects and tool recommendations.
Agent Type: {AgentCatalog.GetAgentName(agentId)}
User Question: {question}

Please provide a helpful and informative response based on your expertise.
Keep the response concise but thorough, and be encouraging while maintaining safety awareness.
";
    }

    private string GenerateFallbackResponse(string agentId, string question)
    {
        var agentName = AgentCatalog.GetAgentName(agentId);
        var agent = AgentCatalog.GetAgent(agentId);

        if (agent != null)
        {
            return $"Hello! I'm the {agentName}. You asked: '{question}'. " +
                   $"{agent.Description}. " +
                   "How can I assist you further with your request?";
        }

        return $"Hello! I'm an AI assistant. You asked: '{question}'. " +
               "How can I help you with your DIY project today?";
    }
}